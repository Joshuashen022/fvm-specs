# Error Conditions

This document specifies the error conditions in the FVM and the associated codes.

## Exit Codes

Exit codes are numeric int32 codes that are returned when an actor exits both successfully and in error.
Exit codes appear on-chain inside the message receipt, and therefore form part of consensus.

### System Exit Codes

System exit codes are exit codes that may only be generated by the system itself and are never
returned from an actor to another actor.

| Code  | Status                     | Description                                               |
|-------|----------------------------|-----------------------------------------------------------|
| 0     | `Ok`                       | success                                                   |
| 1     | `SysErrSenderInvalid`      | sender doesn't exist                                      |
| 2     | `SysErrSenderStateInvalid` | sender's message shouldn't have been included             |
| 3     | reserved                   |                                                           |
| 4     | `SysErrActorPanic`         | message receiver trapped                                  |
| 5     | `SysErrInvalidReceiver`    | receiver doesn't exist and can't be automatically created |
| 6     | `SysErrInsufficientFunds`  | sender didn't have the requisite funds                    |
| 7     | `SysErrOutOfGas`           | out of gas                                                |
| 8     | reserved                   |                                                           |
| 9     | `SysErrIllegalActor`       | message receiver made an unrecoverable illegal syscall    |
| 10-15 | reserved                   |                                                           |

Changes:

1. Removed `SysErrInvalidMethod` (3). Dispatch is now handled inside actor code.
2. Removed `SysErrForbidden` (8). Caller verification is a userspace operation, we'll now return
   `ErrForbidden`.

Questions:

- [ ] `SysErrIllegalActor` would usually mean that the actor exited with an reserved error code. I'd
      strongly consider removing `SysErrActorPanic` in favor of having a single "actor is bugged"
      error code.
- [ ] Can we maybe use negative numbers for reserved codes? That would make our APIs nicer.

### Standardised actor exit codes

Well-known exit codes are codes returned by actors to indicate common error conditions.

| Code  | Status                 | Description                                         |
|-------|------------------------|-----------------------------------------------------|
| 16    | `ErrIllegalArgument`   | invalid message parameters                          |
| 17    | `ErrNotFound`          | message referenced something that doesn't exist     |
| 18    | `ErrForbidden`         | operation forbidden                                 |
| 19    | `ErrInsufficientFunds` | insufficient funds for operation                    |
| 20    | `ErrIllegalState`      | the actor is in an illegal state                    |
| 21    | `ErrSerialization`     | actor failed to serialize or deserialize some state |
| 22    | `ErrInvalidMethod`     | specified method does not exist                     |
| 23-31 | reserved               |                                                     |

Changes:

1. Added `ErrInvalidMethod` (replacing `SysErrInvalidMethod`).

Questions:

- [ ] We currently use `ErrSerialization` to mean both "my state failed to serialize/deserialize"
      and "my parameters, etc." failed to serialize/deserialize. We should probably split these
      cases up to more easily distinguish between "actor bug" and "caller bug".
- [ ] There's no good "generic error". This is useful, e.g., when some sub-call fails with `ErrIllegalArgument` and the calling actor now needs to fail with some form of `ErrIHaveABug`.
- [ ] M2+: Do we want well-known exit codes like this? Instead, we may want:
    - Well-known error "kinds".
    - An error table attached to the actor mapping exit codes to descriptions and error kinds.
    - Alternatively, we could define the lower 16 bits as the "kind" and the upper bits as the
      custom error code. That's probably more efficient.

## Syscall Errors

Syscall errors are errors returned by syscalls to actors. They have some overlap with system errors,
but not entirely.

| Code | Status               | Description                                            |
|------|----------------------|--------------------------------------------------------|
| 0    | Ok                   | syscall succeeded                                      |
| 1    | ErrIllegalArgument   | invalid syscall parameters                             |
| 2    | ErrIllegalActor      | actor is not in the correct state to perform operation |
| 3    | ErrLimit             | some limit was exceeded (e.g. lookback limit)          |
| 4    | ErrBug               | network is bugged but we're continuing anyways         |
| 5    | ErrInsufficientFunds | attempted to send more than balance                    |
| 6    | ErrNotFound          | resource not found                                     |
| 7    | ErrInvalidHandle     | block handle invalid                                   |
| 8    | ErrIllegalCid        | cid creation parameters (hash/length) were invalid     |
| 9    | ErrIllegalCodec      | specified codec is not allowed                         |
| 10   | ErrSerialization     | block format did not match specified codec             |

By syscall:

- `ipld`
    - `open`
        - `ErrNotFound` when the target block isn't in the reachable set.
        - `ErrIllegalArgument` if there's something wrong with the CID.
    - `create`
        - `ErrLimit` if the block is too big.
        - `ErrIllegalCodec` if the passed codec isn't allowed.
            - TODO: just use illegal argument?
        - `ErrSerialization` if the passed block doesn't match the passed codec.
        - `ErrIllegalArgument` if the block isn't in memory, etc.
    - `read`
        - `ErrInvalidHandle` if the handle isn't known.
        - `ErrIllegalArgument` if the passed buffer isn't valid, in memory, etc.
    - `stat`
        - `ErrInvalidHandle` if the handle isn't known.
    - `cid`
        - `ErrInvalidHandle` if the handle isn't known.
        - `ErrIllegalCid` hash code and/or hash length aren't allowed.
            - TODO: just use illegal argument?
        - `ErrIllegalArgument` if the passed buffer isn't valid, in memory, etc.
- `validation*` moved into the actor runtime
- `self`
    - `root`
        - `ErrIllegalActor` actor hasn't set the root yet, or has been deleted.
        - `ErrIllegalArgument` if the passed buffer isn't valid, in memory, etc.
    - `set_root`
        - `ErrIllegalActor` actor has been deleted
        - `ErrInvalidHandle` specified root CID is not in the reachable set.
    - `self_destruct`
        - `ErrNotFound` beneficiary isn't found
        - `ErrIllegalActor` beneficiary is self
        - `ErrIllegalArgument` if the passed address buffer isn't valid, in memory, etc.
- `message*` cannot fail
- `network*` cannot fail
- `actor`
    - `resolve_address`
        - `ErrNotFound` target actor doesn't exist
        - `ErrIllegalArgument` if the passed address buffer isn't valid, in memory, etc.
    - `get_actor_code_cid`
        - `ErrNotFound` target actor doesn't exist
        - `ErrIllegalArgument` if the passed address buffer isn't valid, in memory, etc.
    - `new_actor_address` TODO (likely needs to go)
    - `create_actor` TODO
- `crypto`
    - `verify_signature`
        - `ErrIllegalArgument` signature, address, or plaintext buffers are invalid.
    - `hash_blake2b` (consider removing after benchmarking WASM)
        - `ErrIllegalArgument` invalid buffer
    - `verify_seal`
        - `ErrIllegalArgument` anything
    - `verify_post`
        - `ErrIllegalArgument` anything
    - `compute_unsealed_sector_cid`
        - TODO: new error for unknown proof type?
        - `ErrIllegalArgument` everything else
    - `verify_consensus_fault`
        - `ErrLimit` exceeded lookback limit finding block.
            - TODO is this useful?
        - `ErrIllegalArgument` something else
    - `verify_aggregate_seals`
        - `ErrLimit` exceeds seal aggregation limit.
        - `ErrIllegalArgument` something is malformed
    - `batch_verify_seals`
        - `ErrIllegalArgument` if malformed params
- `rand`
    - `get_chain_randomness`, `get_beacon_randomness`
        - `ErrLimit` lookback exceeds limit.
        - `ErrIllegalArgument` invalid buffer, etc.
- `gas`
    - `charge_gas`
        - `ErrIllegalArgument` invalid name buffer.
- `send`
    - `send`
        - `ErrNotFound` target actor does not exist and cannot be created.
            - The `Executor` turns this into a `SysErrInvalidReceiver` exit code.
        - `ErrInsufficientFunds` tried to send more FIL than available.
            - The `Executor` turns this into a `SysErrInsufficientFunds` exit code.
        - `ErrInvalidHandle` parameters block not found.
        - `ErrLimit` recursion limit reached.
        - `ErrIllegalActor` called actor panicked or returned an invalid result.
            - The `Executor` turns this into a `SysErrIllegalActor` exit code.
        - `ErrIllegalArgument` invalid recipient address buffer.

Notes:

- We're intentionally using `ErrIllegalArgument` instead of `ErrSerialization` in non-IPLD syscalls,
  even if we're using CBOR.
- There is no `ErrForbidden` syscall error code.
    - Calling a forbidden actor will result in an `ErrForbidden` exit code from that actor.
    - Calling a forbidden syscall is statically impossible as it will be impossible to _import_ said
      syscalls. I.e., actor deployment will fail.
- `ErrBug` is an error that the system is allowed to return if the system is in a bad state. This
  should only be returned when the VM believes there's a bug in the network state itself, and is
  trying to continue anyways (e.g., a corrupted actor). It's important to return an error rather than:
    - Failing the block: as long as the entire network can (likely) agree on the same thing being
      wrong, it's better to continue and fix with a network upgrade.
    - Failing the message: the message may need to recover (e.g., might be cron).

Questions:

- [ ] Returning `ErrIllegalActor` from `self_destruct` when the target address is "self" is a bit strange.
