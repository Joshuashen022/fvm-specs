# Error Conditions

This document specifies the error conditions in the FVM and the associated codes.

## Exit Codes

Exit codes are numeric, 32bit integer codes that are returned when an actor exits both successfully and in error.
Exit codes appear on-chain inside the message receipt, and therefore form part of consensus.

We classify exit codes as "normal" and "abnormal".

The only _normal_ exit code is `0`, or `Ok`. The `Ok` exit code indicates that the message was
applied successfully.

All other exit codes are _abnormal_ and indicate that the message _was not_ applied and that the
chain state _was not_ updated.

### System "Abnormal Exit" Codes

System abnormal exit codes are generated by the VM itself to indicate that the message itself failed
to apply. These exit codes will never be observed or returned directly by actors.

| Code  | Status                     | Description                                               |
|-------|----------------------------|-----------------------------------------------------------|
| 1     | `SysErrSenderInvalid`      | sender doesn't exist                                      |
| 2     | `SysErrSenderStateInvalid` | sender's message shouldn't have been included             |
| 3     | reserved                   |                                                           |
| 4     | `SysErrActorPanic`         | message receiver trapped                                  |
| 5     | `SysErrInvalidReceiver`    | receiver doesn't exist and can't be automatically created |
| 6     | `SysErrInsufficientFunds`  | sender didn't have the requisite funds                    |
| 7     | `SysErrOutOfGas`           | out of gas                                                |
| 8     | reserved                   |                                                           |
| 9     | `SysErrIllegalActor`       | message receiver made an unrecoverable illegal syscall    |
| 10    | `SysErrAssertionFailed`    | some internal assertion failed                            |
| 11-15 | reserved                   |                                                           |

Examples:

1. If a message sender doesn't exist on-chain, the VM will return a receipt with the
   `SysErrSenderInvalid` abnormal exit code.
2. If an actor calls `vm::abort` with a system abnormal exit code, the send to that actor will fail
   with the `ErrIllegalActor` _syscall error_. If this is a top-level send (the execution of an
   on-chain message), the `SysErrIllegalActor` system exit code will be recorded as the messages
   exit code.
3. If a message runs out of gas, the VM will return a receipt with the `SysErrOutOfGas` abnormal exit code.

Changes from pre-FVM Filecoin:

1. Removed `SysErrInvalidMethod` (3). Dispatch is now handled inside actor code.
2. Removed `SysErrForbidden` (8). Caller verification is a userspace operation, we'll now return
   `ErrForbidden`.
4. Replaced `SysErrIllegalArgument` with `SysErrAssertionFailed` to more accurately reflect its
   usage. When this appears on-chain, it means that a message hit some internal Filecoin assert that
   shouldn't happen.

### Standard "Abnormal Exit" Codes

Standard abnormal exit codes are codes returned by actors to indicate common abnormal exit conditions.

| Code  | Status                 | Description                                         |
|-------|------------------------|-----------------------------------------------------|
| 16    | `ErrIllegalArgument`   | invalid message parameters                          |
| 17    | `ErrNotFound`          | message referenced something that doesn't exist     |
| 18    | `ErrForbidden`         | operation forbidden                                 |
| 19    | `ErrInsufficientFunds` | insufficient funds for operation                    |
| 20    | `ErrIllegalState`      | the actor is in an illegal state                    |
| 21    | `ErrSerialization`     | actor failed to serialize or deserialize some state |
| 22    | `ErrInvalidMethod`     | specified method does not exist                     |
| 23    | `ErrUnspecified`       | the actor failed with an unspecified error          |
| 24-31 | reserved               |                                                     |

Changes from pre-FVM Filecoin:

1. Added `ErrInvalidMethod` (replacing `SysErrInvalidMethod`).
2. Added `ErrUnspecified`. This generally means "there's a bug and I have no idea what went wrong".
   The alternative would be for the actor to _panic_ (leading to an `ErrIllegalActor` syscall
   error), but it may be useful to distinguish between "crashing" and "something unknown went
   wrong".

## Syscall Errors

Syscall error codes are returned by syscalls to actors. Except `Ok` (0), they indicate that the
syscall failed (without any side effects). The actor may choose to handle the error and continue, or
abort (usually with a standard "abnormal exit" code).

| Code | Status                 | Description                                            |
|------|------------------------|--------------------------------------------------------|
| 0    | `Ok`                   | syscall succeeded                                      |
| 1    | `ErrIllegalArgument`   | invalid syscall parameters                             |
| 2    | `ErrIllegalActor`      | actor is not in the correct state to perform operation |
| 3    | `ErrLimit`             | some limit was exceeded (e.g. lookback limit)          |
| 4    | `ErrAssertionFailed`   | some internal assertion failed                         |
| 5    | `ErrInsufficientFunds` | attempted to send more than balance                    |
| 6    | `ErrNotFound`          | resource not found                                     |
| 7    | `ErrInvalidHandle`     | block handle invalid                                   |
| 8    | `ErrIllegalCid`        | cid creation parameters (hash/length) were invalid     |
| 9    | `ErrIllegalCodec`      | specified codec is not allowed                         |
| 10   | `ErrSerialization`     | block format did not match specified codec             |

**Notes:**

- We intentionally use `ErrIllegalArgument` instead of `ErrSerialization` in non-IPLD syscalls, even
    if we're using CBOR.
- There is no `ErrForbidden` syscall error code:
    - Calling a forbidden actor will result in an `ErrForbidden` exit code from that actor.
    - Calling a forbidden syscall is statically impossible as it will be impossible to _import_ said
        syscalls. I.e., actor deployment will fail.
- `ErrAssertionFailed` is a special error that indicates that some internal assertion failed and
    that there is likely something wrong with a system actor or the Filecoin state-tree itself. It
    exists to allow the network to continue in the face of bugs where the network continuing is likely
    less harmful than the bug itself.

    It can't be caught by normal actors (and turns into a `SysErrAssertionFailed` abnormal exit
    code on-chain), but may be caught by some system actors (e.g., cron).

    Uses:

    - `actor::create_actor` fails because the init actor is in a bad state.
    - `actor::resolve_address` fails because the init actor is in a bad state.

### Error Codes By Syscall

#### `ipld::open`

| Error                | Reason                                            |
|----------------------|---------------------------------------------------|
| `ErrNotFound`        | when the target block isn't in the reachable set. |
| `ErrIllegalArgument` | if there's something wrong with the CID.          |

#### `ipld::create`

| Error                | Reason                                              |
|----------------------|-----------------------------------------------------|
| `ErrLimit`           | if the block is too big.                            |
| `ErrIllegalCodec`    | if the passed codec isn't allowed.                  |
| `ErrSerialization`   | if the passed block doesn't match the passed codec. |
| `ErrIllegalArgument` | if the block isn't in memory, etc.                  |

#### `ipld::read`

| Error                | Reason                                            |
|----------------------|---------------------------------------------------|
| `ErrInvalidHandle`   | if the handle isn't known.                        |
| `ErrIllegalArgument` | if the passed buffer isn't valid, in memory, etc. |

#### `ipld::stat`

| Error              | Reason                     |
|--------------------|----------------------------|
| `ErrInvalidHandle` | if the handle isn't known. |

#### `ipld::cid`

| Error                | Reason                                            |
|----------------------|---------------------------------------------------|
| `ErrInvalidHandle`   | if the handle isn't known.                        |
| `ErrIllegalCid`      | hash code and/or hash length aren't allowed.      |
| `ErrIllegalArgument` | if the passed buffer isn't valid, in memory, etc. |

#### `self::root`

| Error                | Reason                                              |
|----------------------|-----------------------------------------------------|
| `ErrIllegalActor`    | actor hasn't set the root yet, or has been deleted. |
| `ErrIllegalArgument` | if the passed buffer isn't valid, in memory, etc.   |

#### `self::set_root`

| Error              | Reason                                          |
|--------------------|-------------------------------------------------|
| `ErrIllegalActor`  | actor has been deleted                          |
| `ErrInvalidHandle` | specified root CID is not in the reachable set. |

#### `self::self_destruct`

| Error | Reason |
|----
| `ErrNotFound` | beneficiary isn't found |
| `ErrIllegalActor` | beneficiary is self |
| `ErrIllegalArgument` | if the passed address buffer isn't valid, in memory, etc. |

#### `message::*`

Cannot fail.

#### `network::*`

Cannot fail.

#### `actor::resolve_address`

| Error                | Reason                                                    |
|----------------------|-----------------------------------------------------------|
| `ErrNotFound`        | target actor doesn't exist                                |
| `ErrIllegalArgument` | if the passed address buffer isn't valid, in memory, etc. |

#### `actor::get_actor_code_cid`

| Error                | Reason                                                    |
|----------------------|-----------------------------------------------------------|
| `ErrNotFound`        | target actor doesn't exist                                |
| `ErrIllegalArgument` | if the passed address buffer isn't valid, in memory, etc. |

#### `actor::new_actor_address`

TODO (likely needs to go)

#### `actor::create_actor`

TODO

#### `crypto::verify_signature`

| Error                | Reason                                                |
|----------------------|-------------------------------------------------------|
| `ErrIllegalArgument` | signature, address, or plaintext buffers are invalid. |

#### `crypto::hash_blake2b`

| Error                | Reason         |
|----------------------|----------------|
| `ErrIllegalArgument` | invalid buffer |

#### `crypto::verify_seal`

| Error                | Reason   |
|----------------------|----------|
| `ErrIllegalArgument` | anything |

#### `crypto::verify_post`

| Error                | Reason   |
|----------------------|----------|
| `ErrIllegalArgument` | anything |

#### `crypto::compute_unsealed_sector_cid`

| Error                | Reason          |
|----------------------|-----------------|
| `ErrIllegalArgument` | everything else |

#### `crypto::verify_consensus_fault`

| Error                | Reason                                 |
|----------------------|----------------------------------------|
| `ErrLimit`           | exceeded lookback limit finding block. |
| `ErrIllegalArgument` | something else                         |

#### `crypto::verify_aggregate_seals`

| Error                | Reason                          |
|----------------------|---------------------------------|
| `ErrLimit`           | exceeds seal aggregation limit. |
| `ErrIllegalArgument` | something is malformed          |

#### `crypto::batch_verify_seals`

| Error                | Reason              |
|----------------------|---------------------|
| `ErrIllegalArgument` | if malformed params |

#### `rand::get_*_randomness`

| Error                | Reason                  |
|----------------------|-------------------------|
| `ErrLimit`           | lookback exceeds limit. |
| `ErrIllegalArgument` | invalid buffer, etc.    |

#### `gas::charge_gas`

| Error                | Reason               |
|----------------------|----------------------|
| `ErrIllegalArgument` | invalid name buffer. |

#### `send::send`

| Error                  | Reason                                               |
|------------------------|------------------------------------------------------|
| `ErrNotFound`          | target actor does not exist and cannot be created.   |
| `ErrInsufficientFunds` | tried to send more FIL than available.               |
| `ErrInvalidHandle`     | parameters block not found.                          |
| `ErrLimit`             | recursion limit reached.                             |
| `ErrIllegalActor`      | called actor panicked or returned an invalid result. |
| `ErrIllegalArgument`   | invalid recipient address buffer.                    |
